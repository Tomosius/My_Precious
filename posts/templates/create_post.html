{% extends 'base_template.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4 col-12 col-sd-10 col-md-8 col-xl-6">
    <div class="row justify-content-center">
        <div class="col-12 col-sm-8 col-lg-6">
            <fieldset class="d-flex flex-column flex-sm-row align-items-center justify-content-between mb-3">
                <legend class="form-label mb-sm-0">Choose Post Type:</legend>

                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="postType" id="lost" value="lost" onchange="updateSubmitButton()" {% if post_type == 'lost' %}checked{% endif %}>
                        <label class="form-check-label" for="lost">Lost</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="postType" id="found" value="found" onchange="updateSubmitButton()" {% if post_type == 'found' %}checked{% endif %}>
                        <label class="form-check-label" for="found">Found</label>
                    </div>
                </div>
            </fieldset>
        </div>
    </div>

    <div class="row justify-content-center mt-3">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <!-- Hidden input for post type -->
            <input type="hidden" name="post_type" id="hiddenPostType" value="">
            <div class="form-group">
                {{ form.title|as_crispy_field }}
            </div>
            <div class="form-group">
                {{ form.description|as_crispy_field }}
                {{ form.event_date|as_crispy_field }}
                {{ form.date_uncertainty_days|as_crispy_field }}
                {{ form.longitude|as_crispy_field }}
                {{ form.latitude|as_crispy_field }}
            </div>

            <div class="form-group">
                <label for="id_file_field">Upload images:</label>
                {{ image_form.file_field|as_crispy_field }}
            </div>

            <div id="submit-warning" style="display: none; color: red;">You cannot submit the post, please select a post type.</div>

            <div id="map" style="height: 400px; width: 100%;"></div>

            <button type="submit" class="btn btn-primary mb-5" id="submit-btn" disabled>Submit</button>
        </form>
    </div>
</div>

<script>
function updateSubmitButton() {
    let selectedPostType = document.querySelector('input[name="postType"]:checked');
    let isPostTypeSelected = selectedPostType !== null;
    let submitBtn = document.getElementById('submit-btn');
    let warningMsg = document.getElementById('submit-warning');
    let hiddenPostTypeInput = document.getElementById('hiddenPostType');

    submitBtn.disabled = !isPostTypeSelected;
    warningMsg.style.display = isPostTypeSelected ? 'none' : 'block';

    if (isPostTypeSelected) {
        hiddenPostTypeInput.value = selectedPostType.value;
    } else {
        hiddenPostTypeInput.value = ''; // Clear the value if nothing is selected
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updateSubmitButton(); // Ensure correct initial state
});
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap"></script>
<script>
    function initMap() {
        let initialPosition = {lat: -34.397, lng: 150.644};
        let map = new google.maps.Map(document.getElementById('map'), {
            zoom: 8,
            center: initialPosition
        });
        let marker = new google.maps.Marker({
            position: initialPosition,
            map: map,
            draggable: true
        });

        marker.addListener('dragend', function() {
            updateFormFields(marker.getPosition());
        });

        map.addListener('click', function(e) {
            marker.setPosition(e.latLng);
            updateFormFields(e.latLng);
        });
    }

    // Function to update the latitude and longitude form fields.
    function updateFormFields(position) {
        document.getElementById('id_latitude').value = position.lat();
        document.getElementById('id_longitude').value = position.lng();
    }
</script>

{% endblock %}
